// BvusCmsControllerBase.cs 
// PORTAL-DOORS Project Copyright (c) 2007 - 2022 Brain Health Alliance. All Rights Reserved. 
// Software license: the OSI approved Apache 2.0 License (https://opensource.org/licenses/Apache-2.0).

using System.IO;
using System.Threading.Tasks;

using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;

using PDP.DREAM.CoreDataLib.Stores;
using PDP.DREAM.CoreDataLib.Types;
using PDP.DREAM.AcmsWebLib.Controllers;
using PDP.DREAM.AcmsWebLib.Stores;
using PDP.DREAM.ScribeDataLib.Stores;

// BVUS 4-char abbreviation from BhaVI.US
namespace PDP.DREAM.AcmsWebApp.Controllers;

[RequireHttps, Authorize]
[PdpRazorViewRoute(routeAppName, routeAppOrder, routeAppArea)] // attribute on controller or action but not both
public abstract partial class BvusCmsControllerBase : AcmsDataRazorViewControllerBase
{
  protected const string routeAppName = "BVUS";
  protected const int routeAppOrder = 2;
  protected const string routeAppArea = "";

  public BvusCmsControllerBase(QebIdentityContext userCntxt) : base(userCntxt) { }
  public BvusCmsControllerBase(PdpAgentCmsContext agntCntxt) : base(agntCntxt) { }
  public BvusCmsControllerBase(ScribeDbsqlContext npdsCntxt) : base(npdsCntxt) { }
  public BvusCmsControllerBase(QebIdentityContext userCntxt, ScribeDbsqlContext npdsCntxt) : base(userCntxt, npdsCntxt) { }
  public BvusCmsControllerBase(PdpAgentCmsContext agntCntxt, ScribeDbsqlContext npdsCntxt) : base(agntCntxt, npdsCntxt) { }

  // TODO: refactor and re-organize these utility methods
  // for alternative approaches on getting downloading pdf file in aspnetcore
  // https://stackoverflow.com/questions/40486431/return-pdf-to-the-browser-using-asp-net-core
  protected PhysicalFileResult? GetPdfFile(string dirNam, string filNam)
  {
    PhysicalFileResult? pdfFile;
    try
    {
      string path = Path.Combine("~/docs/" + dirNam + "/");
      string fileName = filNam + ".pdf";
      string fileSpec = path + fileName;
      string mimeType = "application/pdf";
      pdfFile = new PhysicalFileResult(fileSpec, mimeType);
    }
    catch
    {
      pdfFile = null;
    }
    return pdfFile;
  }

  public VirtualFileResult? GetPdf(string filename)
  {
    string fileSpec = "/docs/" + filename + ".pdf";
    return GetPdfVirtFile(fileSpec);
  }

  // TODO: dev/retest for Net 6
  public async Task<IActionResult?> GetPdf2(string id)
  {
    FileContentResult? pdfFile;
    string fileName = id + ".pdf";
    string fileSpec = "/docs/" + fileName;
    string mimeType = "application/pdf";
    try
    {
      using (var client = new System.Net.Http.HttpClient())
      {
        byte[] data = await client.GetByteArrayAsync(fileSpec);
        pdfFile = new FileContentResult(data, mimeType)
        {
          FileDownloadName = id
        };
      }
    }
    catch { pdfFile = null; }
    return pdfFile;
  }

  public VirtualFileResult? GetPdfVirtFile(string fileSpec)
  {
    VirtualFileResult? pdfFile;
    try
    {
      string mimeType = "application/pdf";
      pdfFile = new VirtualFileResult(fileSpec, mimeType);
    }
    catch
    {
      pdfFile = null;
    }
    return pdfFile;
  }

} // end class

// end file